<template>
  <n-dropdown :options="options" @select="handleSelect">
    <div id="user-dropdown" class="flex cursor-pointer items-center">
      <n-avatar round :size="36" :src="userStore.avatar || DefaultAvatar" />
      <div v-if="userStore.userInfo" class="ml-12 flex-col flex-shrink-0 items-center">
        <span class="text-16">{{ userStore.userInfo?.nickname ?? userStore.userInfo?.username }}</span>
        <span class="text-12 opacity-50">[{{ RoleLabelMap[userStore.userInfo?.role] }}]</span>
      </div>
    </div>
  </n-dropdown>
</template>

<script setup>
import { useDialog } from 'naive-ui';
import DefaultAvatar from '@/assets/images/default_avatar.png';
import { RoleLabelMap } from '@/constants';
import { fetchLogout } from '@/services';
import { useAuthStore, useUserStore } from '@/stores';

const router = useRouter();
const userStore = useUserStore();
const authStore = useAuthStore();
const dialog = useDialog();

const options = reactive([
  {
    label: '个人资料',
    key: 'profile',
    icon: () => h('i', { class: 'i-material-symbols:person-outline text-16' }),
  },
  {
    label: '系统信息',
    key: 'systemInfo',
    icon: () => h('i', { class: 'i-material-symbols:info-outline text-16' }),
  },
  {
    label: '退出登录',
    key: 'logout',
    icon: () => h('i', { class: 'i-mdi:exit-to-app text-16' }),
  },
]);

function handleSelect(key) {
  switch (key) {
    case 'profile':
      router.push('/profile');
      break;
    case 'systemInfo':
      router.push('/system-info');
      break;
    case 'logout':
      dialog.info({
        title: '提示',
        content: '确认退出？',
        positiveText: '确定',
        negativeText: '取消',
        async onPositiveClick() {
          try {
            await fetchLogout();
          } catch (error) {
            console.error(error);
          }
          authStore.logout();
          $message.success('已退出登录');
        },
      });
      break;
  }
}
</script>
